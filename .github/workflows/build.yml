name: Build coreboot for the KGPE-D16 target
on:
  push:
    branches:
      - asus_kgpe-d16/develop
      - asus_kgpe-d16/release
  pull_request:
    branches:
      - asus_kgpe-d16/develop
      - asus_kgpe-d16/release
    tags:
      - 'asus_kgpe-d16*'

jobs:
  build:
    runs-on: [self-hosted, builder]
    steps:
    - name: Runner information
      run: |
        date
        id -u
        id -g
        ls -la

    # go modules are read only
    # https://github.com/golang/go/issues/35615
    - name: Allow for removal of go modules
      run: | 
        (test -d $GITHUB_WORKSPACE/go && chmod u+w -R $GITHUB_WORKSPACE/go) || true
       

    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        # Checkout pull request HEAD commit instead of merge commit
        # See: https://github.com/actions/checkout#checkout-pull-request-head-commit-instead-of-merge-commit
        ref: ${{ github.event.pull_request.head.sha }}
        # Fetch complete history
        fetch-depth: 0

    - name: Add review.coreboot.org/coreboot.git as origin
      run: |
        git remote add dasharo https://github.com/dasharo/coreboot.git
        git remote set-url origin https://review.coreboot.org/coreboot.git
        git fetch origin

    - name: Repository information
      run: |
        git --version
        git rev-parse --verify HEAD
        git log -n 1
        git log --graph --decorate --pretty=oneline --abbrev-commit -n 20
        git remote -v

    - name: Checkout all submodules
      run: git submodule update --init --recursive --checkout

    # Run build for just one random x86 mainboard so we can finish the build on
    # public runnner. Building all of them takes 4+ hours and we run out of
    # space. This already should give us some idea if we break something in
    # common code.
    - name: Run upstream coreboot tests (for one mainboard)
      run: |
        docker run -v $GITHUB_WORKSPACE:/home/coreboot:rw -i --rm \
          --workdir=/home/coreboot -u$(id -u):$(id -g) coreboot/coreboot-sdk:0ad5fbd48d << EOF
        make -j $(nproc) what-jenkins-does JENKINS_ABUILD_OPT="-t intel/glkrvp"
        EOF

    - name: Build KGPE-D16 8MB target 
      run: |
        docker run -v $GITHUB_WORKSPACE:/home/coreboot:rw -i --rm \
          --workdir=/home/coreboot -u$(id -u):$(id -g) coreboot/coreboot-sdk:0ad5fbd48d << EOF
        make distclean
        cp configs/config.asus_kgpe_d16_8M .config
        make olddefconfig
        make -j $(nproc)
        EOF

    - name: Save KGPE-D16 8MB artifacts
      uses: actions/upload-artifact@v2
      with:
        name: coreboot-binary
        path: |
          build/coreboot.rom
        retention-days: 7

    - name: Build KGPE-D16 16MB target 
      run: |
        docker run -v $GITHUB_WORKSPACE:/home/coreboot:rw -i --rm \
          --workdir=/home/coreboot -u$(id -u):$(id -g) coreboot/coreboot-sdk:0ad5fbd48d << EOF
        make distclean
        cp configs/config.asus_kgpe_d16_16M .config
        make olddefconfig
        make -j $(nproc)
        EOF
    
    - name: Save KGPE-D16 16MB artifacts
      uses: actions/upload-artifact@v2
      with:
        name: coreboot-binary
        path: |
          build/coreboot.rom
        retention-days: 7
